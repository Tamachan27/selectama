<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SELECTAMA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --main-grad: linear-gradient(135deg, #e0e7ff 0%, #fbcfe8 50%, #e9d5ff 100%);
            --accent: #6366f1;
            --glass: rgba(255, 255, 255, 0.5);
            --text: #1f2937;
        }
        body {
            font-family: "Inter", "Hiragino Kaku Gothic ProN", sans-serif;
            background: var(--main-grad);
            background-attachment: fixed;
            margin: 0; padding: 0; color: var(--text);
        }
        .container { max-width: 600px; margin: 0 auto; padding: 60px 20px; }
        
        header { text-align: center; margin-bottom: 50px; }
        h1 { font-size: 3rem; letter-spacing: 6px; font-weight: 900; color: #4338ca; margin: 0; }
        .sub-desc { font-size: 0.7rem; color: #6366f1; letter-spacing: 3px; font-weight: 800; }

        /* „Çø„Ç∞ÈÅ∏Êäû */
        .tag-selector { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 30px; }
        .tag-btn { 
            background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); 
            color: #4338ca; padding: 12px 18px; border-radius: 50px; cursor: pointer; transition: 0.3s; font-weight: 600; 
        }
        .tag-btn.active { background: #4338ca; color: white; }

        #match-btn { 
            width: 100%; padding: 20px; border-radius: 20px; border: none; 
            background: #4338ca; color: white; font-weight: 900; font-size: 1.1rem; 
            cursor: pointer; display: none; box-shadow: 0 10px 25px rgba(67, 56, 202, 0.2);
        }

        /* ÁµêÊûú„Ç®„É™„Ç¢ */
        #result-area { display: none; margin-top: 40px; }
        /* ÁîªÂÉè„Å®„Åó„Å¶‰øùÂ≠ò„Åô„ÇãÁØÑÂõ≤ */
        #capture-target { padding: 20px; background: var(--main-grad); border-radius: 30px; }
        
        .result-card { 
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(15px);
            border-radius: 30px; padding: 30px 20px; border: 1px solid white; 
            text-align: center; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .match-percent { font-size: 2.5rem; font-weight: 900; color: #4338ca; }
        .song-title { font-size: 1.4rem; font-weight: 900; margin: 10px 0 5px; }
        .artist-name { color: #6b7280; font-size: 0.9rem; margin-bottom: 20px; font-weight: 600; }
        
        .yt-btn { 
            display: inline-block; background: #ff0000; color: white; 
            padding: 10px 20px; border-radius: 50px; text-decoration: none; font-size: 0.8rem; font-weight: bold; 
        }

        /* Êìç‰Ωú„Éú„Çø„É≥ */
        .action-btns { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn-save { background: #10b981; color: white; padding: 15px; border-radius: 15px; border: none; font-weight: 800; cursor: pointer; }
        .btn-x { background: #000; color: white; padding: 15px; border-radius: 15px; border: none; font-weight: 800; cursor: pointer; }

        /* „Éó„É≠„Éï„Ç£„Éº„É´ */
        .creator-section { margin-top: 80px; text-align: center; padding: 40px 20px; border-top: 1px solid rgba(0,0,0,0.05); }
        .creator-name { font-weight: 900; font-size: 1.1rem; color: #4338ca; margin-bottom: 15px; }
        .sns-links { display: flex; justify-content: center; gap: 15px; }
        .sns-link { text-decoration: none; font-weight: bold; color: #6366f1; font-size: 0.8rem; background: white; padding: 10px 20px; border-radius: 50px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>SELECTAMA</h1>
        <p class="sub-desc">MUSIC DNA ANALYSIS</p>
    </header>

    <div id="tag-container" class="tag-selector"></div>
    <button id="match-btn" onclick="showMatch()">Start Matching</button>

    <div id="result-area">
        <div id="capture-target">
            <h2 style="text-align:center; font-size:0.8rem; letter-spacing:3px; color:#4338ca;">MY BEST MATCHES</h2>
            <div id="cards-container"></div>
        </div>
        
        <div class="action-btns">
            <button class="btn-save" onclick="saveAsImage()">ÁîªÂÉè„Çí‰øùÂ≠ò„Åô„Çã (Save Image)</button>
            <button class="btn-x" onclick="shareX()">ùïè„Å´ÊäïÁ®ø„Åô„Çã (Post to ùïè)</button>
            <button onclick="location.reload()" style="background:none; border:none; color:#6b7280; cursor:pointer; margin-top:10px;">Reset</button>
        </div>
    </div>

    <div class="creator-section">
        <div class="creator-name">Curated by „Åü„Åæ</div>
        <div class="sns-links">
            <a href="https://open.spotify.com/user/..." class="sns-link" target="_blank">Spotify</a>
            <a href="https://x.com/sunkorot" class="sns-link" target="_blank">ùïè (Twitter)</a>
            <a href="https://on.soundcloud.com/iDHDBLdEl4fV2VCLzw" class="sns-link" target="_blank">SoundCloud</a>
        </div>
    </div>
</div>

<script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTArcbyBXRaH0XklEVYPzISsOv37VX352ZaYYPKu6ntDon8nOJDUT6Q8xob2wXUhJJW0LxpZsps5Evz/pub?output=csv';
    const mainTags = ["#rock", "#technical", "#Internets", "#loud", "#chill", "#energy", "#dark", "#possitive", "#indies", "#male", "#female", "#inst"];
    let selectedTags = new Set();
    let musicData = [];

    async function init() {
        try {
            const res = await fetch(CSV_URL);
            const csvText = await res.text();
            const rows = csvText.split(/\r?\n/).slice(1);
            musicData = rows.map(row => {
                const c = row.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                return { title: c[0], artist: c[1], tags: c[2], url: c[3] };
            }).filter(m => m.title);
            renderTags();
        } catch (e) { console.error(e); }
    }

    function renderTags() {
        const container = document.getElementById('tag-container');
        mainTags.forEach(tag => {
            const btn = document.createElement('button');
            btn.className = 'tag-btn';
            btn.innerText = tag;
            btn.onclick = () => {
                if (selectedTags.has(tag)) { selectedTags.delete(tag); btn.classList.remove('active'); }
                else { selectedTags.add(tag); btn.classList.add('active'); }
                document.getElementById('match-btn').style.display = selectedTags.size > 0 ? 'block' : 'none';
            };
            container.appendChild(btn);
        });
    }

    function showMatch() {
        let results = musicData.map(song => {
            let matchCount = 0;
            selectedTags.forEach(t => { if (song.tags.includes(t)) matchCount++; });
            let percent = Math.round((matchCount / selectedTags.size) * 100);
            return { ...song, percent };
        });

        results.sort((a, b) => b.percent - a.percent || Math.random() - 0.5);
        const bestThree = results.slice(0, 3).filter(r => r.percent > 0);

        const container = document.getElementById('cards-container');
        container.innerHTML = '';
        bestThree.forEach(song => {
            container.innerHTML += `
                <div class="result-card">
                    <div class="match-percent">${song.percent}%</div>
                    <div class="song-title">${song.title}</div>
                    <div class="artist-name">${song.artist}</div>
                    <a href="${song.url}" target="_blank" class="yt-btn">‚ñ∂ YouTube / Listen</a>
                </div>
            `;
        });

        document.getElementById('tag-container').style.display = 'none';
        document.getElementById('match-btn').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';
        window.scrollTo(0,0);
    }

    async function saveAsImage() {
        const target = document.getElementById('capture-target');
        const canvas = await html2canvas(target, { backgroundColor: null, scale: 2 });
        const link = document.createElement('a');
        link.download = 'SELECTAMA_Result.png';
        link.href = canvas.toDataURL();
        link.click();
    }

    function shareX() {
        const text = `SELECTAMAÔºöÁßÅ„Å´„Å¥„Å£„Åü„Çä„ÅÆÊõ≤„ÅØ„Åì„Çå„Åß„Åó„ÅüÔºÅ\n#SELECTAMA #MUSICDNA\n`;
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`, '_blank');
    }
    init();
</script>
</body>
</html>
